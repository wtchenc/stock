<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>當沖計算機 Pro</title>
    <!-- 引入 React 和 Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        input { -webkit-appearance: none; border-radius: 0.5rem; }
        /* 隱藏數字輸入框的箭頭 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

<div id="root"></div>

<script type="text/babel">
    const { useState, useMemo } = React;

    // Icon components
    const Icons = {
        ArrowUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>,
        ArrowDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>,
        Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
        Minus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/></svg>,
        Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
        MoreUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>,
        MoreDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
    };

    const App = () => {
        // --- State ---
        const [tradeType, setTradeType] = useState('long'); // 'long' or 'short'
        const [feeDiscount, setFeeDiscount] = useState(2.8);
        const [isDayTradeTax, setIsDayTradeTax] = useState(true);
        const [minFee, setMinFee] = useState(20);
        
        const [entryPrice, setEntryPrice] = useState(100); 
        const [sheets, setSheets] = useState(1); // 張數

        // Range State for Table
        const [rangeTop, setRangeTop] = useState(5);    // 上方預設顯示 +5 檔
        const [rangeBottom, setRangeBottom] = useState(-5); // 下方預設顯示 -5 檔

        // --- Constants ---
        const FEE_RATE = 0.001425; 
        const TAX_RATE_NORMAL = 0.003;
        const TAX_RATE_DAY = 0.0015;

        // --- Helpers ---
        const currentTaxRate = isDayTradeTax ? TAX_RATE_DAY : TAX_RATE_NORMAL;
        const formatMoney = (val) => new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(val);
        const formatPercent = (val) => new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val) + '%';

        const getTickSize = (price) => {
            if (price < 10) return 0.01;
            if (price < 50) return 0.05;
            if (price < 100) return 0.1;
            if (price < 500) return 0.5;
            if (price < 1000) return 1;
            return 5;
        };

        const addTicks = (price, ticks) => {
            let currentP = price;
            const direction = ticks > 0 ? 1 : -1;
            let count = Math.abs(ticks);
            
            // 簡單保護機制，避免無窮迴圈或過度計算
            let safety = 0;
            while (count > 0 && safety < 1000) {
                const tickSize = getTickSize(currentP);
                let step = tickSize;
                
                // 處理向下跨級距的邊界問題
                if (direction < 0) {
                    if (currentP === 1000) step = 1;
                    else if (currentP === 500) step = 0.5;
                    else if (currentP === 100) step = 0.1;
                    else if (currentP === 50) step = 0.05;
                    else if (currentP === 10) step = 0.01;
                }
                
                currentP += step * direction;
                // 浮點數修正
                currentP = Math.round(currentP * 100) / 100;
                
                if (currentP <= 0) break;
                
                count--;
                safety++;
            }
            return currentP <= 0 ? 0 : currentP;
        };

        const calculateResult = (entry, exit, vol, type) => {
            if (!entry || !exit) return { netProfit: 0, roi: 0 };
            
            let buyPrice = type === 'long' ? entry : exit;
            let sellPrice = type === 'long' ? exit : entry;
            
            const buyCost = Math.floor(buyPrice * vol);
            const sellRevenue = Math.floor(sellPrice * vol);

            let bFee = Math.floor(buyCost * FEE_RATE * (feeDiscount / 10));
            if (bFee < minFee) bFee = minFee;

            let sFee = Math.floor(sellRevenue * FEE_RATE * (feeDiscount / 10));
            if (sFee < minFee) sFee = minFee;

            const tax = Math.floor(sellRevenue * currentTaxRate);
            
            const finalSellPocket = sellRevenue - sFee - tax; 
            const finalBuyPay = buyCost + bFee; 
            const netProfit = finalSellPocket - finalBuyPay;
            
            // 投資成本 (計算 ROI 用)
            const investmentCost = (entry * vol) + (type === 'long' ? bFee : (sFee + tax));
            const roi = investmentCost > 0 ? (netProfit / investmentCost) * 100 : 0;

            return { netProfit, roi };
        };

        const calculateBreakEven = () => {
            let tempExit = entryPrice;
            const direction = tradeType === 'long' ? 1 : -1;
            // 往獲利方向找 200 檔
            for(let i=0; i<200; i++) {
                const res = calculateResult(entryPrice, tempExit, sheets * 1000, tradeType);
                if (res.netProfit >= 0) return tempExit;
                tempExit = addTicks(tempExit, 1 * direction);
            }
            return entryPrice;
        };

        // --- Memos ---
        const breakEvenPrice = useMemo(() => calculateBreakEven(), [entryPrice, sheets, tradeType, feeDiscount, isDayTradeTax, minFee]);

        const simulationTable = useMemo(() => {
            const rows = [];
            // 從上方 rangeTop 到下方 rangeBottom
            for (let i = rangeTop; i >= rangeBottom; i--) {
                const direction = tradeType === 'long' ? 1 : -1;
                
                // 這裡的 i 是「獲利檔位」，正數代表賺的方向，負數代表賠的方向
                let p = addTicks(entryPrice, i * direction);
                
                if (p <= 0) continue;
                
                const res = calculateResult(entryPrice, p, sheets * 1000, tradeType);
                rows.push({
                    price: p,
                    diffTick: i,
                    ...res
                });
            }
            return rows;
        }, [entryPrice, sheets, tradeType, feeDiscount, isDayTradeTax, minFee, rangeTop, rangeBottom]);

        const isLong = tradeType === 'long';
        
        const getProfitColor = (val) => {
            if (val > 0) return 'text-red-600 font-bold';
            if (val < 0) return 'text-green-600 font-bold';
            return 'text-gray-400';
        };

        const getProfitBg = (val) => {
            if (val > 0) return 'bg-red-50';
            if (val < 0) return 'bg-green-50';
            return 'bg-white';
        };

        // --- Handlers ---
        const handleExpandTop = () => setRangeTop(prev => prev + 5);
        const handleExpandBottom = () => setRangeBottom(prev => prev - 5);

        return (
            <div className="min-h-screen pb-20 max-w-lg mx-auto bg-gray-50 shadow-2xl overflow-hidden min-h-screen border-x border-gray-200">
                
                {/* Header Area */}
                <div className="bg-white p-4 shadow-sm sticky top-0 z-10">
                    <div className="flex items-center justify-between mb-3">
                         <div className="flex items-center gap-2">
                            <div className={`p-1.5 rounded-lg ${isLong ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                {isLong ? <Icons.ArrowUp /> : <Icons.ArrowDown />}
                            </div>
                            <h1 className="font-bold text-gray-800 text-lg">當沖試算</h1>
                         </div>
                         <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => setTradeType('long')} className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all ${isLong ? 'bg-white text-red-600 shadow-sm' : 'text-gray-400'}`}>做多</button>
                            <button onClick={() => setTradeType('short')} className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all ${!isLong ? 'bg-white text-green-600 shadow-sm' : 'text-gray-400'}`}>做空</button>
                        </div>
                    </div>

                    {/* Quick Input Row */}
                    <div className="flex gap-3">
                        <div className="flex-1">
                            <label className={`text-xs font-bold block mb-1 ${isLong ? 'text-red-700' : 'text-green-700'}`}>成本價</label>
                            <input 
                                type="number" step="0.1" inputMode="decimal"
                                value={entryPrice} 
                                onChange={(e) => setEntryPrice(Number(e.target.value))} 
                                className={`w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-2xl font-mono font-bold outline-none focus:ring-2 ${isLong ? 'focus:ring-red-200' : 'focus:ring-green-200'}`}
                            />
                        </div>
                        <div className="w-1/3">
                            <label className="text-xs font-bold text-gray-500 block mb-1">張數</label>
                            <div className="relative">
                                <input 
                                    type="number" step="1" inputMode="numeric"
                                    value={sheets} 
                                    onChange={(e) => setSheets(Number(e.target.value))} 
                                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-xl font-mono text-center outline-none focus:ring-2 focus:ring-blue-100"
                                />
                                <div className="absolute right-0 top-0 h-full flex flex-col border-l border-gray-200">
                                    <button onClick={() => setSheets(s => s+1)} className="flex-1 px-1.5 hover:bg-gray-200 text-gray-500"><Icons.Plus /></button>
                                    <button onClick={() => setSheets(s => Math.max(1, s-1))} className="flex-1 px-1.5 hover:bg-gray-200 text-gray-500"><Icons.Minus /></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Settings & Info Bar */}
                <div className="px-4 py-2 grid grid-cols-12 gap-2 text-xs text-gray-500 bg-white border-b border-gray-100">
                    <div className="col-span-4 flex items-center gap-1 bg-gray-50 px-2 py-1 rounded">
                        <span>折數</span>
                        <input type="number" step="0.1" value={feeDiscount} onChange={e => setFeeDiscount(Number(e.target.value))} className="w-full bg-transparent text-center font-bold text-gray-700 outline-none" />
                    </div>
                    <div className="col-span-4 flex items-center justify-center gap-1 bg-gray-50 px-2 py-1 rounded">
                        <input type="checkbox" checked={isDayTradeTax} onChange={() => setIsDayTradeTax(!isDayTradeTax)} id="tax" className="accent-blue-600" />
                        <label htmlFor="tax">當沖稅</label>
                    </div>
                    <div className="col-span-4 flex flex-col justify-center items-center bg-yellow-50 text-yellow-800 rounded px-1 font-bold">
                        <span>保本: {breakEvenPrice}</span>
                    </div>
                </div>

                {/* Main Table */}
                <div className="bg-white">
                    {/* Expand Top Button Area */}
                    <div className="flex border-b border-gray-100">
                        {rangeTop > 5 && (
                            <button 
                                onClick={() => setRangeTop(5)}
                                className="w-24 py-3 text-xs text-gray-400 font-medium bg-gray-50 hover:bg-gray-100 border-r border-gray-200 transition-colors"
                            >
                                收合
                            </button>
                        )}
                        <button 
                            onClick={handleExpandTop}
                            className="flex-1 py-3 text-xs text-blue-500 font-medium bg-blue-50/50 hover:bg-blue-50 flex items-center justify-center gap-1 transition-colors"
                        >
                            <Icons.MoreUp /> 查看更高價位 (+5)
                        </button>
                    </div>

                    <div className="w-full">
                        <div className="grid grid-cols-4 text-xs text-gray-400 border-b py-2 px-4 bg-gray-50/80 sticky top-[154px]">
                            <div className="text-left">檔位</div>
                            <div className="text-right">{isLong ? '賣出價' : '回補價'}</div>
                            <div className="text-right">損益</div>
                            <div className="text-right">報酬率</div>
                        </div>
                        
                        <div className="divide-y divide-gray-100">
                            {simulationTable.map((row) => (
                                <div key={row.price} className={`grid grid-cols-4 py-2.5 px-4 items-center transition-colors ${row.price === entryPrice ? 'bg-blue-50 ring-1 ring-blue-100 z-10 relative' : getProfitBg(row.netProfit)} ${row.price === breakEvenPrice && row.price !== entryPrice ? 'bg-yellow-50' : ''}`}>
                                    
                                    {/* Column 1: Tick Label */}
                                    <div className="text-left">
                                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${
                                            row.diffTick > 0 ? 'bg-red-100 text-red-600' : 
                                            row.diffTick < 0 ? 'bg-green-100 text-green-600' : 
                                            'bg-blue-600 text-white'
                                        }`}>
                                            {row.diffTick === 0 ? '成本' : row.diffTick > 0 ? `+${row.diffTick}` : row.diffTick}
                                        </span>
                                        {row.price === breakEvenPrice && row.diffTick !== 0 && <span className="ml-1 text-[9px] text-yellow-600 font-bold border border-yellow-200 px-1 rounded bg-white">保本</span>}
                                    </div>

                                    {/* Column 2: Price */}
                                    <div className={`text-right font-mono font-medium text-base ${isLong ? 'text-gray-800' : 'text-blue-900'}`}>
                                        {row.price}
                                    </div>

                                    {/* Column 3: Net Profit */}
                                    <div className={`text-right font-mono text-base ${getProfitColor(row.netProfit)}`}>
                                        {row.netProfit > 0 ? '+' : ''}{row.netProfit}
                                    </div>

                                    {/* Column 4: ROI */}
                                    <div className={`text-right font-mono text-xs ${getProfitColor(row.roi)}`}>
                                        {formatPercent(row.roi)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Expand Bottom Button Area */}
                    <div className="flex border-t border-gray-100 mb-8">
                        {rangeBottom < -5 && (
                            <button 
                                onClick={() => setRangeBottom(-5)}
                                className="w-24 py-4 text-xs text-gray-400 font-medium bg-gray-50 hover:bg-gray-100 border-r border-gray-200 transition-colors"
                            >
                                收合
                            </button>
                        )}
                        <button 
                            onClick={handleExpandBottom}
                            className="flex-1 py-4 text-xs text-blue-500 font-medium bg-blue-50/50 hover:bg-blue-50 flex items-center justify-center gap-1 transition-colors"
                        >
                            <Icons.MoreDown /> 查看更低價位 (+5)
                        </button>
                    </div>
                </div>

                <div className="text-center text-[10px] text-gray-300 py-4 bg-gray-50">
                    當沖計算機 Pro v2.2
                </div>

            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>